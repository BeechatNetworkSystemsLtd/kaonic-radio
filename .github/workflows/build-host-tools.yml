name: Build Kaonic Host Tools

on:
  push:
    branches: [ main ]

  workflow_dispatch:

jobs:
  build-host-tools-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install build dependencies
        run: brew install protobuf

      - name: Build Host-Tools for macOS
        working-directory: ${{ github.workspace }}
        run: |
          echo 'exclude = ["kaonic-gui", "kaonic-iperf"]' >> Cargo.toml
          cd ./kaonic-iperf
          cargo build --release --target aarch64-apple-darwin --no-default-features --features machine-host
          cd ../kaonic-gui
          cargo build --release --target aarch64-apple-darwin --no-default-features --features machine-host

      - name: Prepare macOS artifacts
        run: |
          mkdir -p deploy/macos
          cp kaonic-iperf/target/aarch64-apple-darwin/release/kaonic-iperf deploy/macos/
          cp kaonic-gui/target/aarch64-apple-darwin/release/kaonic-gui deploy/macos/

      - name: Upload macOS artifacts (temporary)
        uses: actions/upload-artifact@v4
        with:
          name: host-tools-macos
          path: deploy/macos
          retention-days: 1

  build-host-tools-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Build Host-Tools for Linux
        working-directory: ${{ github.workspace }}
        run: |
          echo 'exclude = ["kaonic-gui", "kaonic-iperf"]' >> Cargo.toml
          cd ./kaonic-iperf
          cargo build --release --target x86_64-unknown-linux-gnu --no-default-features --features machine-host
          cd ../kaonic-gui
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Prepare Linux artifacts
        run: |
          mkdir -p deploy/linux
          cp kaonic-iperf/target/x86_64-unknown-linux-gnu/release/kaonic-iperf deploy/linux/
          cp kaonic-gui/target/x86_64-unknown-linux-gnu/release/kaonic-gui deploy/linux/

      - name: Upload Linux artifacts (temporary)
        uses: actions/upload-artifact@v4
        with:
          name: host-tools-linux
          path: deploy/linux
          retention-days: 1

  build-host-tools-windows:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Install build dependencies
        run: |
          brew install protobuf
          brew install mingw-w64
          rustup target add x86_64-pc-windows-gnu

      - name: Build Host-Tools for Windows
        working-directory: ${{ github.workspace }}
        run: |
          echo 'exclude = ["kaonic-gui", "kaonic-iperf"]' >> Cargo.toml
          cd ./kaonic-iperf
          cargo build --release --target x86_64-pc-windows-gnu --no-default-features --features machine-host
          cd ../kaonic-gui
          cargo build --release --target x86_64-pc-windows-gnu

      - name: Prepare Windows artifacts
        run: |
          mkdir -p deploy/windows
          cp kaonic-iperf/target/x86_64-pc-windows-gnu/release/kaonic-iperf.exe deploy/windows/
          cp kaonic-gui/target/x86_64-pc-windows-gnu/release/kaonic-gui.exe deploy/windows/
          # Copy required DLLs
          SYSROOT="$(x86_64-w64-mingw32-gcc -print-sysroot)/mingw"
          cp "$SYSROOT/bin/libwinpthread-1.dll" deploy/windows/ || true
          cp "$SYSROOT/lib/libatomic-1.dll" deploy/windows/ || true
          cp "$SYSROOT/lib/libstdc++-6.dll" deploy/windows/ || true

      - name: Upload Windows artifacts (temporary)
        uses: actions/upload-artifact@v4
        with:
          name: host-tools-windows
          path: deploy/windows
          retention-days: 1

  build-kaonic1s-apps:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-tags: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: apt-cache-${{ runner.os }}-${{ hashFiles('.github/workflows/build-host-tools.yml') }}
          restore-keys: |
            apt-cache-${{ runner.os }}-

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build build-essential python3-pip
          pip3 install cryptography pathlib
          rustup target add armv7-unknown-linux-gnueabihf

      - name: Install Kaonic Yocto SDK
        run: |
          ASSET_NAME="stm32mp1-kaonic-proto-sdk-aarch64.sh"
          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/BeechatNetworkSystemsLtd/kaonic-yocto/releases/latest \
            | grep "browser_download_url" \
            | grep "$ASSET_NAME" \
            | cut -d '"' -f 4)
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "SDK asset not found in latest release."
            exit 1
          fi
          echo "Downloading SDK from $DOWNLOAD_URL"
          wget -q "$DOWNLOAD_URL" -O yocto-sdk.sh
          chmod +x yocto-sdk.sh
          echo "Installing Yocto SDK..."
          ./yocto-sdk.sh -y -d /opt/yocto-sdk

      - name: Build 'kaonic-commd' with machine-kaonic1s feature
        run: |
          unset LD_LIBRARY_PATH
          source /opt/yocto-sdk/environment-setup
          cargo build --release -p kaonic-commd --features machine-kaonic1s

      - name: Create Kaonic OTA package
        run: |
          echo $(git describe --tags --long)
          mkdir -p deploy
          echo "${{ secrets.BEECHAT_KAONIC_COMM_OTA_KEY }}" > ota_sign_key.pem
          chmod 600 ota_sign_key.pem
          python3 scripts/create-ota.py \
            -o ./deploy \
            -s ota_sign_key.pem \
            --keep

      - name: Upload OTA package artifact (temporary)
        uses: actions/upload-artifact@v4
        with:
          name: kaonic-comm-ota
          path: deploy/kaonic-comm-ota/*
          retention-days: 1

  pack-artifacts:
    needs: [build-host-tools-macos, build-host-tools-linux, build-host-tools-windows, build-kaonic1s-apps]
    runs-on: ubuntu-latest
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: host-tools-macos
          path: package/host-tools/macos

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: host-tools-linux
          path: package/host-tools/linux

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: host-tools-windows
          path: package/host-tools/windows

      - name: Download OTA package
        uses: actions/download-artifact@v4
        with:
          name: kaonic-comm-ota
          path: temp-ota

      - name: Create OTA zip and organize structure
        run: |
          mkdir -p package/kaonic1s
          cd temp-ota
          zip -r ../package/kaonic1s/kaonic-commd-ota.zip .
          cd ..
          rm -rf temp-ota

      - name: Create zip archive
        run: |
          zip -r kaonic-radio.zip package/
          ls -lh kaonic-radio.zip
          echo "Archive contents:"
          unzip -l kaonic-radio.zip | head -20

      - name: Upload zip archive
        uses: actions/upload-artifact@v4
        with:
          name: kaonic-radio-zip
          path: kaonic-radio.zip
